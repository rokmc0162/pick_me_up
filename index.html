<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PICK ME UP - è¨­å®šé›†</title>
<style>
:root {
  --bg: #ffffff;
  --bg-secondary: #f6f8fa;
  --bg-hover: #f0f4f8;
  --border: #d0d7de;
  --border-light: #e5e9ed;
  --text: #1f2328;
  --text-secondary: #555d67;
  --text-muted: #8b949e;
  --accent: #0969da;
  --accent-light: #ddf4ff;
  --orange: #bf5700;
  --orange-bg: #fff8f0;
  --green: #1a7f37;
  --green-bg: #f0fff4;
  --purple: #6639ba;
  --purple-bg: #fbf3ff;
  --red: #cf222e;
  --highlight: #fff2cc;
  --radius: 10px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', 'Noto Sans JP', sans-serif;
  background: var(--bg-secondary);
  color: var(--text);
  line-height: 1.7;
  font-size: 15px;
}

/* HEADER */
.header {
  position: sticky; top: 0; z-index: 100;
  background: #fff;
  border-bottom: 1px solid var(--border);
  padding: 14px 28px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.header-top {
  display: flex; align-items: center; gap: 20px; margin-bottom: 12px;
}
.logo {
  font-size: 22px; font-weight: 800; color: var(--accent);
  letter-spacing: 0.5px; white-space: nowrap;
}
.logo-sub { font-size: 13px; color: var(--text-muted); white-space: nowrap; }

/* SEARCH */
.search-container { flex: 1; max-width: 580px; position: relative; }
.search-input {
  width: 100%; padding: 12px 18px 12px 44px;
  background: var(--bg-secondary); border: 2px solid var(--border);
  border-radius: var(--radius); color: var(--text);
  font-size: 15px; outline: none; transition: all 0.2s;
}
.search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); background: #fff; }
.search-input::placeholder { color: var(--text-muted); }
.search-icon {
  position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 18px; pointer-events: none;
}
.search-count {
  position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
  font-size: 13px; color: var(--accent); background: var(--accent-light);
  padding: 2px 10px; border-radius: 12px; font-weight: 600; display: none;
}
.search-count.visible { display: block; }
.search-clear {
  position: absolute; right: 80px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  font-size: 20px; display: none; line-height: 1;
}
.search-clear.visible { display: block; }
.search-clear:hover { color: var(--text); }
.shortcut-hint {
  font-size: 12px; color: var(--text-muted); margin-left: auto;
  display: flex; align-items: center; gap: 10px; white-space: nowrap;
}
kbd {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: 4px; padding: 1px 6px; font-size: 11px; font-family: inherit;
}

/* TABS */
.tabs-container {
  display: flex; gap: 6px; overflow-x: auto;
  scrollbar-width: none; padding-bottom: 2px;
}
.tabs-container::-webkit-scrollbar { display: none; }
.tab {
  padding: 8px 16px; font-size: 14px; font-weight: 600;
  color: var(--text-secondary); background: transparent;
  border: 2px solid transparent; border-radius: var(--radius);
  cursor: pointer; white-space: nowrap; transition: all 0.15s; flex-shrink: 0;
}
.tab:hover { color: var(--text); background: var(--bg-secondary); }
.tab.active { color: var(--accent); background: var(--accent-light); border-color: var(--accent); }
.tab .tab-count { font-size: 12px; color: var(--text-muted); margin-left: 4px; }
.tab.active .tab-count { color: var(--accent); }

/* CONTENT */
.content { padding: 24px 28px; max-width: 1700px; margin: 0 auto; }

/* TABLE */
.sheet-section { margin-bottom: 32px; }
.sheet-title {
  font-size: 20px; font-weight: 700; color: var(--text);
  margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
}
.sheet-title .badge {
  font-size: 13px; padding: 3px 12px; background: var(--accent-light);
  color: var(--accent); border-radius: 12px; font-weight: 600;
}
.table-wrapper {
  overflow-x: auto; border: 1px solid var(--border);
  border-radius: var(--radius); background: #fff; box-shadow: var(--shadow);
}
table { width: 100%; border-collapse: collapse; font-size: 15px; }
thead th {
  position: sticky; top: 0; z-index: 10;
  background: var(--bg-secondary); color: var(--text);
  font-weight: 700; font-size: 14px;
  padding: 14px 16px; text-align: left;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
}
tbody tr { transition: background 0.1s; }
tbody tr:hover { background: var(--bg-hover); }
tbody tr:not(:last-child) td { border-bottom: 1px solid var(--border-light); }
td { padding: 14px 16px; vertical-align: top; max-width: 500px; line-height: 1.7; }
td.cell-kr { color: var(--orange); font-weight: 600; font-size: 16px; }
td.cell-jp { color: var(--green); font-weight: 600; font-size: 16px; }
td.cell-desc { color: var(--text-secondary); }
td.cell-num { color: var(--purple); text-align: center; white-space: nowrap; font-weight: 600; }
td.cell-img { text-align: center; padding: 8px; }
td.cell-img img {
  max-width: 120px; max-height: 150px; border-radius: 8px;
  border: 1px solid var(--border); object-fit: contain;
  cursor: pointer; transition: transform 0.2s;
}
td.cell-img img:hover { transform: scale(1.05); box-shadow: var(--shadow-lg); }

/* CATEGORY ROW */
tr.cat-row td {
  background: var(--accent-light); color: var(--accent);
  font-weight: 700; font-size: 15px; padding: 10px 16px;
  border-bottom: 2px solid rgba(9,105,218,0.2) !important;
}

/* CELL */
.cell-content {
  white-space: pre-wrap; word-break: break-word; cursor: pointer;
  padding: 4px 6px; border-radius: 6px; transition: background 0.1s;
}
.cell-content:hover { background: var(--bg-hover); }
.cell-edit {
  width: 100%; min-height: 60px; background: #fff;
  color: var(--text); border: 2px solid var(--accent);
  font-family: inherit; font-size: 15px; line-height: 1.6;
  resize: vertical; outline: none; padding: 8px 10px; border-radius: 6px;
}
mark { background: var(--highlight); color: var(--orange); padding: 1px 3px; border-radius: 3px; font-weight: 600; }

/* TOAST */
.copy-toast {
  position: fixed; bottom: 28px; right: 28px;
  background: var(--green); color: #fff;
  padding: 12px 24px; border-radius: var(--radius);
  font-size: 14px; font-weight: 600;
  opacity: 0; transform: translateY(10px); transition: all 0.3s;
  pointer-events: none; z-index: 1000; box-shadow: var(--shadow-lg);
}
.copy-toast.visible { opacity: 1; transform: translateY(0); }

/* CARD VIEW */
.char-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 18px;
}
.char-card {
  background: #fff; border: 1px solid var(--border);
  border-radius: var(--radius); padding: 22px; transition: all 0.2s;
  box-shadow: var(--shadow);
}
.char-card:hover { border-color: var(--accent); box-shadow: var(--shadow-lg); }
.char-card-header {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid var(--border-light);
  gap: 14px;
}
.char-card-header-left { display: flex; gap: 16px; align-items: flex-start; flex: 1; }
.char-img {
  width: 80px; height: 100px; border-radius: 8px;
  border: 1px solid var(--border); object-fit: cover; flex-shrink: 0;
  cursor: pointer;
}
.char-img:hover { box-shadow: var(--shadow-lg); }
.char-name-kr { font-size: 20px; font-weight: 800; color: var(--orange); }
.char-name-jp { font-size: 16px; color: var(--green); font-weight: 600; margin-top: 2px; }
.char-meta { display: flex; gap: 6px; flex-wrap: wrap; flex-shrink: 0; }
.char-badge { font-size: 12px; padding: 3px 10px; border-radius: 12px; font-weight: 600; }
.char-badge-gender { background: var(--purple-bg); color: var(--purple); }
.char-badge-ep { background: var(--accent-light); color: var(--accent); }
.char-field { margin-bottom: 10px; }
.char-field-label {
  font-size: 12px; color: var(--text-muted); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;
}
.char-field-value {
  font-size: 15px; color: var(--text-secondary); white-space: pre-wrap;
  word-break: break-word; cursor: pointer; padding: 4px 6px;
  border-radius: 6px; transition: background 0.1s; line-height: 1.7;
}
.char-field-value:hover { background: var(--bg-hover); }

/* VIEW TOGGLE */
.view-toggle { display: flex; gap: 4px; margin-left: auto; }
.view-btn {
  padding: 6px 14px; font-size: 13px; font-weight: 600;
  border: 2px solid var(--border); background: #fff;
  color: var(--text-secondary); border-radius: var(--radius);
  cursor: pointer; transition: all 0.15s;
}
.view-btn.active { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

/* IMAGE MODAL */
.img-modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: none; align-items: center; justify-content: center;
  z-index: 9999; cursor: pointer;
}
.img-modal.visible { display: flex; }
.img-modal img {
  max-width: 90vw; max-height: 90vh; border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

/* EMPTY */
.empty-state { text-align: center; padding: 80px 20px; color: var(--text-muted); }
.empty-state-icon { font-size: 56px; margin-bottom: 16px; }
.empty-state-title { font-size: 20px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* RESPONSIVE */
@media (max-width: 768px) {
  .header { padding: 10px 14px; }
  .header-top { flex-wrap: wrap; }
  .search-container { max-width: 100%; order: 3; width: 100%; }
  .shortcut-hint { display: none; }
  .content { padding: 14px; }
  .char-grid { grid-template-columns: 1fr; }
  td { padding: 10px 12px; font-size: 14px; }
}

/* BACK TO TOP */
.back-top {
  position: fixed; bottom: 28px; left: 28px;
  width: 44px; height: 44px; border-radius: 50%;
  background: #fff; border: 2px solid var(--border);
  color: var(--text-secondary); font-size: 20px;
  cursor: pointer; display: none; align-items: center; justify-content: center;
  transition: all 0.2s; z-index: 100; box-shadow: var(--shadow);
}
.back-top:hover { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
.back-top.visible { display: flex; }

/* ADD ROW BUTTON */
.add-row-btn {
  padding: 6px 16px; font-size: 13px; font-weight: 700;
  background: var(--green); color: #fff; border: none;
  border-radius: var(--radius); cursor: pointer; transition: all 0.15s;
  display: inline-flex; align-items: center; gap: 6px; margin-left: 12px;
}
.add-row-btn:hover { background: #15692e; box-shadow: var(--shadow); }

/* ADD ROW MODAL */
.add-modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  display: none; align-items: center; justify-content: center;
  z-index: 9998; padding: 20px; overflow-y: auto;
}
.add-modal-overlay.visible { display: flex; }
.add-modal {
  background: #fff; border-radius: 14px; width: 100%; max-width: 640px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25); position: relative;
  max-height: 90vh; display: flex; flex-direction: column;
}
.add-modal-header {
  padding: 20px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.add-modal-title { font-size: 18px; font-weight: 700; color: var(--text); }
.add-modal-close {
  width: 32px; height: 32px; border-radius: 50%; border: none;
  background: var(--bg-secondary); color: var(--text-secondary);
  font-size: 18px; cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all 0.15s;
}
.add-modal-close:hover { background: var(--red); color: #fff; }
.add-modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
.add-modal-field { margin-bottom: 16px; }
.add-modal-field label {
  display: block; font-size: 13px; font-weight: 700;
  color: var(--text-secondary); margin-bottom: 5px;
  text-transform: uppercase; letter-spacing: 0.3px;
}
.add-modal-field input[type="text"],
.add-modal-field textarea {
  width: 100%; padding: 10px 14px; border: 2px solid var(--border);
  border-radius: 8px; font-size: 15px; font-family: inherit;
  color: var(--text); outline: none; transition: border-color 0.2s;
  background: #fff; line-height: 1.6;
}
.add-modal-field input[type="text"]:focus,
.add-modal-field textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
.add-modal-field textarea { resize: vertical; min-height: 70px; }

/* IMAGE UPLOAD */
.img-upload-area {
  border: 2px dashed var(--border); border-radius: 10px;
  padding: 20px; text-align: center; cursor: pointer;
  transition: all 0.2s; position: relative; background: var(--bg-secondary);
}
.img-upload-area:hover { border-color: var(--accent); background: var(--accent-light); }
.img-upload-area.has-image { padding: 10px; border-style: solid; border-color: var(--green); background: var(--green-bg); }
.img-upload-area input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer;
}
.img-upload-icon { font-size: 32px; margin-bottom: 6px; }
.img-upload-text { font-size: 13px; color: var(--text-muted); }
.img-upload-preview {
  max-width: 120px; max-height: 150px; border-radius: 8px;
  border: 1px solid var(--border); object-fit: contain;
}
.img-upload-remove {
  position: absolute; top: 6px; right: 6px;
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--red); color: #fff; border: none;
  font-size: 14px; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
}

/* MODAL FOOTER */
.add-modal-footer {
  padding: 16px 24px; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 10px;
}
.add-modal-footer button {
  padding: 10px 24px; font-size: 14px; font-weight: 700;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.15s;
}
.btn-cancel { background: var(--bg-secondary); color: var(--text-secondary); }
.btn-cancel:hover { background: var(--border); }
.btn-save { background: var(--green); color: #fff; }
.btn-save:hover { background: #15692e; }

/* USER-ADDED ROW INDICATOR */
tr.user-added td:first-child::before {
  content: 'âœ¨'; margin-right: 4px; font-size: 12px;
}
.user-row-badge {
  display: inline-block; font-size: 10px; padding: 1px 6px;
  background: #e8f5e9; color: var(--green); border-radius: 8px;
  font-weight: 700; margin-left: 6px; vertical-align: middle;
}
.user-row-delete {
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; font-size: 16px; padding: 2px 6px; border-radius: 4px;
  transition: all 0.15s; margin-left: 4px;
}
.user-row-delete:hover { background: #ffeef0; color: var(--red); }
.char-card.user-added { border-left: 3px solid var(--green); }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div>
      <div class="logo">PICK ME UP è¨­å®šé›†</div>
      <div class="logo-sub">~ä½ãƒ¬ã‚¢â˜…è‹±é›„ã®æˆã‚Šä¸ŠãŒã‚Š~</div>
    </div>
    <div class="search-container">
      <span class="search-icon">&#128269;</span>
      <input type="text" class="search-input" id="searchInput"
        placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (KR/JP/ì„¤ëª… ëª¨ë‘, ìŠ¤í˜ì´ìŠ¤=AND)" autocomplete="off">
      <button class="search-clear" id="searchClear" onclick="clearSearch()">&times;</button>
      <span class="search-count" id="searchCount"></span>
    </div>
    <div class="shortcut-hint">
      <span><kbd>&#8984;K</kbd> ê²€ìƒ‰</span>
      <span>í´ë¦­=ë³µì‚¬</span>
      <span>ë”ë¸”í´ë¦­=í¸ì§‘</span>
    </div>
  </div>
  <div class="tabs-container" id="tabs"></div>
</div>

<div class="content" id="content"></div>
<div class="copy-toast" id="copyToast"></div>
<button class="back-top" id="backTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>
<div class="img-modal" id="imgModal" onclick="this.classList.remove('visible')"><img id="imgModalImg"></div>
<div class="add-modal-overlay" id="addModal">
  <div class="add-modal">
    <div class="add-modal-header">
      <div class="add-modal-title" id="addModalTitle">ìƒˆ í–‰ ì¶”ê°€</div>
      <button class="add-modal-close" onclick="closeAddModal()">&times;</button>
    </div>
    <div class="add-modal-body" id="addModalBody"></div>
    <div class="add-modal-footer">
      <button class="btn-cancel" onclick="closeAddModal()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="saveNewRow()">âœ… ì €ì¥</button>
    </div>
  </div>
</div>

<script src="data.js"></script>
<script src="img_mapping.js"></script>
<script>
const SHEET_CONFIG = {
  '1. charapter': {
    label: 'ìºë¦­í„°', icon: '&#128100;',
    headers: ['ë“±ì¥í™”', 'KR', 'JP', 'ì´ë¯¸ì§€', 'ì„±ë³„', 'ë‚˜ì´', '1ì¸ì¹­', 'í˜¸ì¹­', 'ë§íˆ¬', 'ì„¤ì •/íŠ¹ì§•', 'í˜¸ì¹­(íƒ€ì¸)'],
    colMap: [1, 2, 3, -1, 5, 6, 7, 8, 9, 10, 11],
    imgCol: 3, // index in colMap where image goes
    dataStart: 1, cardView: true,
    cellClasses: {0:'cell-num', 1:'cell-kr', 2:'cell-jp', 3:'cell-img'},
  },
  '2. word': {
    label: 'ìš©ì–´ì‚¬ì „', icon: '&#128214;',
    headers: ['ì†Œì„¤í™”', 'ì›¹íˆ°í™”', 'KR', 'JP(ì›¹íˆ°)', 'JP(ì†Œì„¤)', 'ì„¤ëª…'],
    colMap: [0, 1, 2, 3, 4, 5],
    dataStart: 2,
    cellClasses: {0:'cell-num', 1:'cell-num', 2:'cell-kr', 3:'cell-jp', 4:'cell-jp', 5:'cell-desc'},
  },
  'ã‚²ãƒ¼ãƒ å†…è¡¨è¨˜ï¼ˆæ¼«ç”»ç”¨ï¼‰': {
    label: 'ê²Œì„ë‚´ í‘œê¸°', icon: '&#127918;',
    headers: ['ì¹´í…Œê³ ë¦¬', 'ì¢…ë¥˜', 'KR', 'JP', 'ë¹„ê³ '],
    colMap: [0, 1, 2, 3, 4],
    dataStart: 3,
    cellClasses: {0:'cell-num', 2:'cell-kr', 3:'cell-jp', 4:'cell-desc'},
  },
  'ã€å‚è€ƒç”¨ã€‘ãƒãƒ™ãƒ«å…ˆè¡Œåˆ†æ¦‚è¦ãŠã‚ˆã³STè©²å½“è©±': {
    label: 'ë…¸ë²¨/ST', icon: '&#128218;',
    headers: ['STí™”', 'í‚¤ì›Œë“œ', 'ì£¼ìš”ì¸ë¬¼', 'ì†Œì„¤í™”', 'ì†Œì„¤íƒ€ì´í‹€'],
    colMap: [1, 2, 3, 4, 5],
    dataStart: 1,
    cellClasses: {0:'cell-num', 3:'cell-num'},
  },
  'ã‚¢ã‚¤ãƒ†ãƒ  æ²ç¤ºæ¿ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ï¼ˆæ¼«ç”»ç”¨ï¼‰': {
    label: 'ì•„ì´í…œ/ê²Œì‹œíŒ', icon: '&#128451;',
    headers: null, dataStart: 0, hasSheetImages: true,
  },
  'ì˜ì›… ì •ë³´è‹±é›„æƒ…å ±(ì°¸ì¡°ìš©ìœ¼ë¡œ ë´ì£¼ì„¸ìš”)': {
    label: 'ì˜ì›… ì •ë³´', icon: '&#9876;',
    headers: null, dataStart: 0,
  },
  'ì‹œìŠ¤í…œì°½ í‘œê¸° í†µì¼(ì°¸ì¡°)': {
    label: 'ì‹œìŠ¤í…œì°½', icon: '&#128421;',
    headers: null, dataStart: 0,
  },
  'ê²Œì„ ui ì •ë¦¬': {
    label: 'ê²Œì„ UI', icon: '&#128241;',
    headers: ['ë“±ì¥í™”ìˆ˜', 'ë¶„ë¥˜', 'KR', 'JP', 'ë¹„ê³ '],
    colMap: [0, 1, 2, 3, 4],
    dataStart: 3,
    cellClasses: {0:'cell-num', 2:'cell-kr', 3:'cell-jp', 4:'cell-desc'},
  },
  'ì¤„ê±°ë¦¬ì‹œíŠ¸': {
    label: 'ì¤„ê±°ë¦¬', icon: '&#128221;',
    headers: ['í™”ì°¨', 'ì¤„ê±°ë¦¬', 'ë“±ì¥ì¸ë¬¼', 'ë“±ì¥ ìŠ¤í‚¬', 'ì‚¬ë§ì¸ì›'],
    colMap: [0, 1, 2, 3, 4],
    dataStart: 3,
    cellClasses: {0:'cell-num'},
  },
  'í™•ì¸ ìš”ì²­': {
    label: 'í™•ì¸ ìš”ì²­', icon: '&#9989;',
    headers: null, dataStart: 0,
  },
  '05.confirm': {
    label: 'ì»¨íŒ', icon: '&#128203;',
    headers: ['No.', 'Item', 'KR', 'JP', 'í™•ì¸', 'Date'],
    colMap: [0, 1, 2, 3, 4, 5],
    dataStart: 4,
    cellClasses: {0:'cell-num', 2:'cell-kr', 3:'cell-jp'},
  },
};

// Build per-row image lookup: { "sheetName": { rowIdx: "imageFile.png" } }
const IMG_BY_ROW = {};
for (const [sheet, imgs] of Object.entries(IMG_MAP)) {
  IMG_BY_ROW[sheet] = {};
  for (const img of imgs) {
    // For character sheet, col=4 is the image column
    if (sheet === '1. charapter' && img.col === 4) {
      IMG_BY_ROW[sheet][img.row] = img.file;
    }
    // Store all images by row+col for other sheets
    const key = `${img.row}_${img.col}`;
    if (!IMG_BY_ROW[sheet]._all) IMG_BY_ROW[sheet]._all = {};
    IMG_BY_ROW[sheet]._all[key] = img.file;
  }
}

let currentTab = '__all__';
let currentSearch = '';
let charViewMode = 'card';
let searchTimer = null;

let savedEdits = {};
try { savedEdits = JSON.parse(localStorage.getItem('pmu_edits') || '{}'); } catch(e) {}
function applyEdits() {
  for (const [k, edits] of Object.entries(savedEdits)) {
    const data = RAW_DATA[k];
    if (!data) continue;
    for (const [ri, ci, val] of edits) { if (data[ri]) data[ri][ci] = val; }
  }
}
applyEdits();

// === USER-ADDED ROWS ===
let addedRows = {};
try { addedRows = JSON.parse(localStorage.getItem('pmu_added') || '{}'); } catch(e) {}
let addedImages = {};
try { addedImages = JSON.parse(localStorage.getItem('pmu_added_imgs') || '{}'); } catch(e) {}

let addModalSheet = '';
let addModalImgData = null;

function openAddModal(sheetKey) {
  addModalSheet = sheetKey;
  addModalImgData = null;
  const cfg = SHEET_CONFIG[sheetKey];
  const modal = document.getElementById('addModal');
  const title = document.getElementById('addModalTitle');
  const body = document.getElementById('addModalBody');
  title.innerHTML = `${cfg.icon} ${cfg.label} â€” ìƒˆ í–‰ ì¶”ê°€`;

  let html = '';
  if (cfg.headers && cfg.colMap) {
    for (let i = 0; i < cfg.headers.length; i++) {
      const hdr = cfg.headers[i];
      const ci = cfg.colMap[i];
      if (ci === -1 && sheetKey === '1. charapter') {
        // Image upload field
        html += `<div class="add-modal-field">
          <label>${hdr}</label>
          <div class="img-upload-area" id="imgUploadArea" onclick="document.getElementById('imgFileInput').click()">
            <input type="file" id="imgFileInput" accept="image/*" onchange="handleImgUpload(event)">
            <div id="imgUploadContent"><div class="img-upload-icon">ğŸ“·</div><div class="img-upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ<br>(PNG, JPG ë“±)</div></div>
          </div>
        </div>`;
      } else {
        const isLong = ['ì„¤ì •/íŠ¹ì§•', 'ì„¤ëª…', 'ì¤„ê±°ë¦¬', 'ë§íˆ¬', 'í˜¸ì¹­(íƒ€ì¸)', 'ë¹„ê³ ', 'ì„¤ì • ë° íŠ¹ì§•'].includes(hdr);
        if (isLong) {
          html += `<div class="add-modal-field"><label>${hdr}</label><textarea data-col-idx="${i}" placeholder="${hdr} ì…ë ¥"></textarea></div>`;
        } else {
          html += `<div class="add-modal-field"><label>${hdr}</label><input type="text" data-col-idx="${i}" placeholder="${hdr} ì…ë ¥"></div>`;
        }
      }
    }
  } else {
    // Generic: show 6 text fields
    const maxC = 6;
    for (let i = 0; i < maxC; i++) {
      html += `<div class="add-modal-field"><label>Col ${i+1}</label><input type="text" data-col-idx="${i}" placeholder="Col ${i+1} ì…ë ¥"></div>`;
    }
    html += `<div class="add-modal-field">
      <label>ì´ë¯¸ì§€ (ì„ íƒ)</label>
      <div class="img-upload-area" id="imgUploadArea" onclick="document.getElementById('imgFileInput').click()">
        <input type="file" id="imgFileInput" accept="image/*" onchange="handleImgUpload(event)">
        <div id="imgUploadContent"><div class="img-upload-icon">ğŸ“·</div><div class="img-upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ (ì„ íƒì‚¬í•­)</div></div>
      </div>
    </div>`;
  }
  body.innerHTML = html;
  modal.classList.add('visible');
  // Auto focus first input
  setTimeout(() => { const first = body.querySelector('input[type="text"], textarea'); if (first) first.focus(); }, 100);
}

function closeAddModal() {
  document.getElementById('addModal').classList.remove('visible');
  addModalImgData = null;
}

function handleImgUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    addModalImgData = ev.target.result;
    const area = document.getElementById('imgUploadArea');
    area.classList.add('has-image');
    document.getElementById('imgUploadContent').innerHTML =
      `<img class="img-upload-preview" src="${addModalImgData}">
       <button class="img-upload-remove" onclick="event.stopPropagation(); removeUploadImg()">&times;</button>
       <div class="img-upload-text" style="margin-top:6px">ì´ë¯¸ì§€ ì„ íƒë¨ âœ“</div>`;
  };
  reader.readAsDataURL(file);
}

function removeUploadImg() {
  addModalImgData = null;
  const area = document.getElementById('imgUploadArea');
  area.classList.remove('has-image');
  document.getElementById('imgUploadContent').innerHTML =
    `<div class="img-upload-icon">ğŸ“·</div><div class="img-upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</div>`;
  document.getElementById('imgFileInput').value = '';
}

function saveNewRow() {
  const body = document.getElementById('addModalBody');
  const cfg = SHEET_CONFIG[addModalSheet];
  let rowData;
  if (cfg.colMap) {
    const maxOrigCol = Math.max(...cfg.colMap.filter(c => c >= 0)) + 1;
    rowData = new Array(Math.max(maxOrigCol, 12)).fill('');
    const inputs = body.querySelectorAll('[data-col-idx]');
    inputs.forEach(inp => {
      const i = parseInt(inp.dataset.colIdx);
      const ci = cfg.colMap[i];
      if (ci >= 0) rowData[ci] = inp.value.trim();
    });
  } else {
    rowData = [];
    const inputs = body.querySelectorAll('[data-col-idx]');
    inputs.forEach(inp => { rowData.push(inp.value.trim()); });
  }

  // Check at least one field has content
  if (rowData.every(v => !v) && !addModalImgData) {
    showToast('âš ï¸ ìµœì†Œ í•˜ë‚˜ì˜ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }

  // Save row
  if (!addedRows[addModalSheet]) addedRows[addModalSheet] = [];
  const rowId = Date.now() + '_' + Math.random().toString(36).slice(2,6);
  addedRows[addModalSheet].push({ id: rowId, data: rowData });
  localStorage.setItem('pmu_added', JSON.stringify(addedRows));

  // Save image
  if (addModalImgData) {
    if (!addedImages[addModalSheet]) addedImages[addModalSheet] = {};
    addedImages[addModalSheet][rowId] = addModalImgData;
    localStorage.setItem('pmu_added_imgs', JSON.stringify(addedImages));
  }

  closeAddModal();
  renderContent();
  updateTabCounts();
  showToast('âœ… ìƒˆ í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function deleteAddedRow(sheetKey, rowId) {
  if (!confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  if (addedRows[sheetKey]) {
    addedRows[sheetKey] = addedRows[sheetKey].filter(r => r.id !== rowId);
    if (addedRows[sheetKey].length === 0) delete addedRows[sheetKey];
    localStorage.setItem('pmu_added', JSON.stringify(addedRows));
  }
  if (addedImages[sheetKey]?.[rowId]) {
    delete addedImages[sheetKey][rowId];
    localStorage.setItem('pmu_added_imgs', JSON.stringify(addedImages));
  }
  renderContent();
  updateTabCounts();
  showToast('ğŸ—‘ï¸ í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function getAddedRowImg(sheetKey, rowId) {
  return addedImages[sheetKey]?.[rowId] || null;
}
// Close modal on outside click or Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeAddModal();
});
document.getElementById('addModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('addModal')) closeAddModal();
});

function init() {
  buildTabs();
  renderContent();
  const input = document.getElementById('searchInput');
  input.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      currentSearch = input.value.trim();
      document.getElementById('searchClear').classList.toggle('visible', currentSearch.length > 0);
      renderContent(); updateTabCounts();
    }, 150);
  });
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); input.focus(); input.select(); }
    if (e.key === 'Escape') { clearSearch(); input.blur(); document.getElementById('imgModal').classList.remove('visible'); }
  });
  window.addEventListener('scroll', () => {
    document.getElementById('backTop').classList.toggle('visible', window.scrollY > 400);
  });
}

function clearSearch() {
  document.getElementById('searchInput').value = ''; currentSearch = '';
  document.getElementById('searchClear').classList.remove('visible');
  renderContent(); updateTabCounts();
}

function buildTabs() {
  const c = document.getElementById('tabs');
  let h = `<button class="tab active" data-tab="__all__" onclick="switchTab('__all__')">&#128270; ì „ì²´</button>`;
  for (const [key, cfg] of Object.entries(SHEET_CONFIG)) {
    if (!RAW_DATA[key]) continue;
    const cnt = getDataRows(key).length;
    h += `<button class="tab" data-tab="${key}" onclick="switchTab('${key}')">${cfg.icon} ${cfg.label} <span class="tab-count">${cnt}</span></button>`;
  }
  c.innerHTML = h;
}

function updateTabCounts() {
  if (!currentSearch) { buildTabs(); switchTab(currentTab); return; }
  const terms = currentSearch.toLowerCase().split(/\s+/);
  document.querySelectorAll('.tab[data-tab]').forEach(tab => {
    const key = tab.dataset.tab;
    if (key === '__all__') return;
    const cnt = getDataRows(key).filter(r => { const t = r.join(' ').toLowerCase(); return terms.every(term => t.includes(term)); }).length;
    const el = tab.querySelector('.tab-count');
    if (el) { el.textContent = cnt; el.style.color = cnt > 0 ? 'var(--orange)' : ''; el.style.fontWeight = cnt > 0 ? '700' : ''; }
  });
}

function getDataRows(key) {
  const data = RAW_DATA[key]; const cfg = SHEET_CONFIG[key];
  if (!data || !cfg) return [];
  const orig = data.slice(cfg.dataStart || 0).filter(r => r.some(c => c.trim()));
  // Include user-added rows in count
  const userCount = (addedRows[key] || []).length;
  if (userCount > 0) {
    const extra = (addedRows[key] || []).map(ur => ur.data);
    return [...orig, ...extra];
  }
  return orig;
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  renderContent();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function renderContent() {
  const container = document.getElementById('content');
  let total = 0;
  if (currentTab === '__all__') {
    let html = '';
    for (const [key, cfg] of Object.entries(SHEET_CONFIG)) {
      const r = renderSheet(key, cfg, true);
      // When searching, only show sheets with matches
      if (currentSearch) {
        if (r.mc > 0) html += r.html;
      } else {
        html += r.html;
      }
      total += r.mc;
    }
    container.innerHTML = (currentSearch && total === 0) ? renderEmpty() : html;
  } else {
    const cfg = SHEET_CONFIG[currentTab];
    if (cfg) { const r = renderSheet(currentTab, cfg, false); total = r.mc; container.innerHTML = (currentSearch && total === 0) ? renderEmpty() : r.html; }
  }
  const ce = document.getElementById('searchCount');
  if (currentSearch) { ce.textContent = `${total}ê±´`; ce.classList.add('visible'); } else { ce.classList.remove('visible'); }
}

function renderEmpty() {
  return `<div class="empty-state"><div class="empty-state-icon">&#128269;</div><div class="empty-state-title">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div><p>"${esc(currentSearch)}"ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>`;
}

function renderSheet(key, cfg, isGlobal) {
  const data = RAW_DATA[key];
  if (!data || !data.length) return { html: '', mc: 0 };
  if (key === '1. charapter' && charViewMode === 'card') return renderCards(key, cfg, data, isGlobal);
  return renderTable(key, cfg, data, isGlobal);
}

function filterRows(rows) {
  if (!currentSearch) return rows;
  const terms = currentSearch.toLowerCase().split(/\s+/);
  return rows.filter(r => { const t = r.join(' ').toLowerCase(); return terms.every(term => t.includes(term)); });
}

function getCharImg(rowIdx) {
  const m = IMG_BY_ROW['1. charapter'];
  return m ? m[rowIdx] : null;
}

function renderTable(key, cfg, data, isGlobal) {
  const colMap = cfg.colMap;
  let rows = data.slice(cfg.dataStart || 0).filter(r => r.some(c => c.trim()));
  // Merge user-added rows
  const userRows = addedRows[key] || [];
  let filtered = filterRows(rows);
  let filteredUser = currentSearch ? userRows.filter(ur => { const t = ur.data.join(' ').toLowerCase(); const terms = currentSearch.toLowerCase().split(/\s+/); return terms.every(term => t.includes(term)); }) : userRows;
  const mc = currentSearch ? filtered.length + filteredUser.length : rows.length + userRows.length;
  if (currentSearch && mc === 0 && isGlobal) return { html: '', mc: 0 };
  const display = currentSearch ? filtered : rows;
  const displayUser = currentSearch ? filteredUser : userRows;
  const totalCount = display.length + displayUser.length;

  let html = `<div class="sheet-section"><div class="sheet-title">${cfg.icon} ${cfg.label} <span class="badge">${totalCount}ê±´</span>${key === '1. charapter' ? viewToggle() : ''}<button class="add-row-btn" onclick="openAddModal('${key}')">â• í–‰ ì¶”ê°€</button></div><div class="table-wrapper"><table>`;

  if (cfg.headers && colMap) {
    html += '<thead><tr>' + cfg.headers.map(h => `<th>${h}</th>`).join('') + '<th></th></tr></thead>';
  } else {
    const maxC = Math.min(data.reduce((m, r) => Math.max(m, r.filter(c => c.trim()).length), 0), 12);
    html += '<thead><tr>' + Array.from({length: maxC}, (_, i) => `<th>Col ${i+1}</th>`).join('') + '<th></th></tr></thead>';
  }

  html += '<tbody>';
  // Original rows
  for (const row of display) {
    const rowIdx = data.indexOf(row);
    html += '<tr>';
    if (colMap) {
      for (let i = 0; i < colMap.length; i++) {
        const ci = colMap[i];
        const cls = cfg.cellClasses?.[i] || '';
        if (ci === -1 && key === '1. charapter') {
          const imgFile = getCharImg(rowIdx);
          html += `<td class="cell-img">${imgFile ? `<img src="images/${imgFile}" onclick="showImg(this.src)" loading="lazy" alt="ìºë¦­í„°">` : '<span style="color:var(--text-muted)">-</span>'}</td>`;
        } else if (ci === -1) {
          html += '<td>-</td>';
        } else {
          const val = ci < row.length ? row[ci] : '';
          html += `<td class="${cls}">${cell(val, key, rowIdx, ci)}</td>`;
        }
      }
    } else {
      const maxC = Math.min(row.filter(c => c.trim()).length + 1, 12);
      const sheetImgs = IMG_BY_ROW[key]?._all || {};
      for (let i = 0; i < maxC; i++) {
        const imgKey = `${rowIdx}_${i}`;
        const imgFile = sheetImgs[imgKey];
        if (imgFile) {
          html += `<td class="cell-img"><img src="images/${imgFile}" onclick="showImg(this.src)" loading="lazy">${row[i]?.trim() ? '<br>' + cell(row[i], key, rowIdx, i) : ''}</td>`;
        } else {
          html += `<td>${cell(row[i] || '', key, rowIdx, i)}</td>`;
        }
      }
    }
    html += '<td></td></tr>';
  }
  // User-added rows
  for (const ur of displayUser) {
    html += '<tr class="user-added">';
    if (colMap) {
      for (let i = 0; i < colMap.length; i++) {
        const ci = colMap[i];
        const cls = cfg.cellClasses?.[i] || '';
        if (ci === -1 && key === '1. charapter') {
          const imgData = getAddedRowImg(key, ur.id);
          html += `<td class="cell-img">${imgData ? `<img src="${imgData}" onclick="showImg(this.src)" loading="lazy">` : '<span style="color:var(--text-muted)">-</span>'}</td>`;
        } else if (ci === -1) {
          html += '<td>-</td>';
        } else {
          const val = ci < ur.data.length ? ur.data[ci] : '';
          html += `<td class="${cls}"><div class="cell-content" onclick="copyText(this)">${hl(esc(val || ''))}</div></td>`;
        }
      }
    } else {
      for (let i = 0; i < Math.max(ur.data.length, 1); i++) {
        const imgData = getAddedRowImg(key, ur.id);
        if (i === 0 && imgData) {
          html += `<td class="cell-img"><img src="${imgData}" onclick="showImg(this.src)" loading="lazy">${ur.data[i]?.trim() ? '<br>' + esc(ur.data[i]) : ''}</td>`;
        } else {
          html += `<td><div class="cell-content" onclick="copyText(this)">${hl(esc(ur.data[i] || ''))}</div></td>`;
        }
      }
    }
    html += `<td><span class="user-row-badge">NEW</span><button class="user-row-delete" onclick="deleteAddedRow('${key}','${ur.id}')" title="ì‚­ì œ">ğŸ—‘</button></td></tr>`;
  }
  html += '</tbody></table></div></div>';
  return { html, mc };
}

function renderCards(key, cfg, data, isGlobal) {
  let rows = data.slice(cfg.dataStart || 0).filter(r => r.some(c => c.trim()));
  rows = rows.filter(r => (r[2]?.trim()) || (r[3]?.trim()));
  const userRows = addedRows[key] || [];
  let filtered = filterRows(rows);
  let filteredUser = currentSearch ? userRows.filter(ur => { const t = ur.data.join(' ').toLowerCase(); const terms = currentSearch.toLowerCase().split(/\s+/); return terms.every(term => t.includes(term)); }) : userRows;
  const mc = currentSearch ? filtered.length + filteredUser.length : rows.length + userRows.length;
  if (currentSearch && mc === 0 && isGlobal) return { html: '', mc: 0 };
  const display = currentSearch ? filtered : rows;
  const displayUser = currentSearch ? filteredUser : userRows;
  const totalCount = display.length + displayUser.length;

  let html = `<div class="sheet-section"><div class="sheet-title">${cfg.icon} ${cfg.label} <span class="badge">${totalCount}ê±´</span>${viewToggle()}<button class="add-row-btn" onclick="openAddModal('${key}')">â• í–‰ ì¶”ê°€</button></div><div class="char-grid">`;

  for (const row of display) {
    const rowIdx = data.indexOf(row);
    const [kr, jp, gender, age, ep, pro, called, speech, desc, callOth] =
      [row[2]||'', row[3]||'', row[5]||'', row[6]||'', row[1]||'', row[7]||'', row[8]||'', row[9]||'', row[10]||'', row[11]||''];
    const imgFile = getCharImg(rowIdx);

    html += `<div class="char-card"><div class="char-card-header"><div class="char-card-header-left">`;
    if (imgFile) {
      html += `<img class="char-img" src="images/${imgFile}" onclick="showImg(this.src)" loading="lazy" alt="${esc(kr)}">`;
    }
    html += `<div><div class="char-name-kr">${hl(esc(kr))}</div><div class="char-name-jp">${hl(esc(jp))}</div></div></div>`;
    html += `<div class="char-meta">${gender ? `<span class="char-badge char-badge-gender">${esc(gender)}</span>` : ''}${ep ? `<span class="char-badge char-badge-ep">EP.${esc(String(ep))}</span>` : ''}</div></div>`;

    for (const [lbl, val] of [['ë‚˜ì´', age], ['1ì¸ì¹­', pro], ['í˜¸ì¹­', called], ['ë§íˆ¬/ì–´ë¯¸', speech], ['ì„¤ì • ë° íŠ¹ì§•', desc], ['í˜¸ì¹­(íƒ€ì¸ì—ê²Œ)', callOth]]) {
      if (val?.trim()) {
        html += `<div class="char-field"><div class="char-field-label">${lbl}</div><div class="char-field-value" onclick="copyText(this)">${hl(esc(val))}</div></div>`;
      }
    }
    html += '</div>';
  }
  // User-added cards
  for (const ur of displayUser) {
    const d = ur.data;
    const [kr, jp, gender, age, ep, pro, called, speech, desc, callOth] =
      [d[2]||'', d[3]||'', d[5]||'', d[6]||'', d[1]||'', d[7]||'', d[8]||'', d[9]||'', d[10]||'', d[11]||''];
    const imgData = getAddedRowImg(key, ur.id);

    html += `<div class="char-card user-added"><div class="char-card-header"><div class="char-card-header-left">`;
    if (imgData) {
      html += `<img class="char-img" src="${imgData}" onclick="showImg(this.src)" loading="lazy" alt="${esc(kr)}">`;
    }
    html += `<div><div class="char-name-kr">${hl(esc(kr))} <span class="user-row-badge">NEW</span></div><div class="char-name-jp">${hl(esc(jp))}</div></div></div>`;
    html += `<div class="char-meta"><button class="user-row-delete" onclick="deleteAddedRow('${key}','${ur.id}')" title="ì‚­ì œ">ğŸ—‘</button>`;
    html += `${gender ? `<span class="char-badge char-badge-gender">${esc(gender)}</span>` : ''}${ep ? `<span class="char-badge char-badge-ep">EP.${esc(String(ep))}</span>` : ''}</div></div>`;

    for (const [lbl, val] of [['ë‚˜ì´', age], ['1ì¸ì¹­', pro], ['í˜¸ì¹­', called], ['ë§íˆ¬/ì–´ë¯¸', speech], ['ì„¤ì • ë° íŠ¹ì§•', desc], ['í˜¸ì¹­(íƒ€ì¸ì—ê²Œ)', callOth]]) {
      if (val?.trim()) {
        html += `<div class="char-field"><div class="char-field-label">${lbl}</div><div class="char-field-value" onclick="copyText(this)">${hl(esc(val))}</div></div>`;
      }
    }
    html += '</div>';
  }
  html += '</div></div>';
  return { html, mc };
}

function viewToggle() {
  return `<div class="view-toggle"><button class="view-btn ${charViewMode==='card'?'active':''}" onclick="toggleView('card')">&#127183; ì¹´ë“œ</button><button class="view-btn ${charViewMode==='table'?'active':''}" onclick="toggleView('table')">&#128200; í…Œì´ë¸”</button></div>`;
}
function toggleView(m) { charViewMode = m; renderContent(); }

function cell(value, sk, ri, ci) {
  if (!value?.trim()) return '<span style="color:var(--text-muted)">-</span>';
  const id = `${sk}|${ri}|${ci}`;
  return `<div class="cell-content" onclick="copyText(this)" ondblclick="editCell(this,'${btoa(encodeURIComponent(id))}')" title="í´ë¦­=ë³µì‚¬">${hl(esc(value))}</div>`;
}

function showImg(src) {
  const modal = document.getElementById('imgModal');
  document.getElementById('imgModalImg').src = src;
  modal.classList.add('visible');
}

function editCell(el, idB64) {
  const id = decodeURIComponent(atob(idB64));
  const [sheet, ri, ci] = id.split('|');
  const row = RAW_DATA[sheet]?.[parseInt(ri)];
  if (!row) return;
  const ta = document.createElement('textarea');
  ta.className = 'cell-edit'; ta.value = row[parseInt(ci)] || '';
  el.replaceWith(ta); ta.focus();
  ta.style.height = Math.max(60, ta.scrollHeight) + 'px';
  const save = () => {
    row[parseInt(ci)] = ta.value;
    if (!savedEdits[sheet]) savedEdits[sheet] = [];
    savedEdits[sheet] = savedEdits[sheet].filter(e => !(e[0]===parseInt(ri) && e[1]===parseInt(ci)));
    savedEdits[sheet].push([parseInt(ri), parseInt(ci), ta.value]);
    localStorage.setItem('pmu_edits', JSON.stringify(savedEdits));
    renderContent(); showToast('ì €ì¥ë¨');
  };
  ta.addEventListener('blur', save);
  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { ta.removeEventListener('blur', save); renderContent(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') save();
  });
}

function copyText(el) {
  const text = el.textContent || el.innerText;
  navigator.clipboard.writeText(text).then(() => {
    showToast('ë³µì‚¬ë¨: ' + (text.length > 40 ? text.slice(0,40)+'...' : text));
  }).catch(() => {
    const ta = document.createElement('textarea'); ta.value = text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('ë³µì‚¬ë¨');
  });
}

function showToast(msg) {
  const t = document.getElementById('copyToast');
  t.textContent = msg; t.classList.add('visible');
  clearTimeout(t._timer); t._timer = setTimeout(() => t.classList.remove('visible'), 1500);
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,'<br>'); }
function hl(text) {
  if (!currentSearch) return text;
  let r = text;
  for (const t of currentSearch.split(/\s+/).filter(Boolean))
    r = r.replace(new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>');
  return r;
}

init();
</script>
</body>
</html>
