<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PICK ME UP - 設定集</title>
<style>
:root {
  --bg: #ffffff;
  --bg-secondary: #f6f8fa;
  --bg-hover: #f0f4f8;
  --border: #d0d7de;
  --border-light: #e5e9ed;
  --text: #1f2328;
  --text-secondary: #555d67;
  --text-muted: #8b949e;
  --accent: #0969da;
  --accent-light: #ddf4ff;
  --orange: #bf5700;
  --orange-bg: #fff8f0;
  --green: #1a7f37;
  --green-bg: #f0fff4;
  --purple: #6639ba;
  --purple-bg: #fbf3ff;
  --red: #cf222e;
  --highlight: #fff2cc;
  --radius: 10px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', 'Noto Sans JP', sans-serif;
  background: var(--bg-secondary);
  color: var(--text);
  line-height: 1.7;
  font-size: 15px;
}

/* HEADER */
.header {
  position: sticky; top: 0; z-index: 100;
  background: #fff;
  border-bottom: 1px solid var(--border);
  padding: 14px 28px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.header-top {
  display: flex; align-items: center; gap: 20px; margin-bottom: 12px;
}
.logo {
  font-size: 22px; font-weight: 800; color: var(--accent);
  letter-spacing: 0.5px; white-space: nowrap;
}
.logo-sub { font-size: 13px; color: var(--text-muted); white-space: nowrap; }

/* SEARCH */
.search-container { flex: 1; max-width: 580px; position: relative; }
.search-input {
  width: 100%; padding: 12px 18px 12px 44px;
  background: var(--bg-secondary); border: 2px solid var(--border);
  border-radius: var(--radius); color: var(--text);
  font-size: 15px; outline: none; transition: all 0.2s;
}
.search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); background: #fff; }
.search-input::placeholder { color: var(--text-muted); }
.search-icon {
  position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 18px; pointer-events: none;
}
.search-count {
  position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
  font-size: 13px; color: var(--accent); background: var(--accent-light);
  padding: 2px 10px; border-radius: 12px; font-weight: 600; display: none;
}
.search-count.visible { display: block; }
.search-clear {
  position: absolute; right: 80px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  font-size: 20px; display: none; line-height: 1;
}
.search-clear.visible { display: block; }
.search-clear:hover { color: var(--text); }
.shortcut-hint {
  font-size: 12px; color: var(--text-muted); margin-left: auto;
  display: flex; align-items: center; gap: 10px; white-space: nowrap;
}
kbd {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: 4px; padding: 1px 6px; font-size: 11px; font-family: inherit;
}

/* TABS */
.tabs-container {
  display: flex; gap: 6px; overflow-x: auto;
  scrollbar-width: none; padding-bottom: 2px;
}
.tabs-container::-webkit-scrollbar { display: none; }
.tab {
  padding: 8px 16px; font-size: 14px; font-weight: 600;
  color: var(--text-secondary); background: transparent;
  border: 2px solid transparent; border-radius: var(--radius);
  cursor: pointer; white-space: nowrap; transition: all 0.15s; flex-shrink: 0;
}
.tab:hover { color: var(--text); background: var(--bg-secondary); }
.tab.active { color: var(--accent); background: var(--accent-light); border-color: var(--accent); }
.tab .tab-count { font-size: 12px; color: var(--text-muted); margin-left: 4px; }
.tab.active .tab-count { color: var(--accent); }

/* CONTENT */
.content { padding: 24px 28px; max-width: 1700px; margin: 0 auto; }

/* TABLE */
.sheet-section { margin-bottom: 32px; }
.sheet-title {
  font-size: 20px; font-weight: 700; color: var(--text);
  margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
}
.sheet-title .badge {
  font-size: 13px; padding: 3px 12px; background: var(--accent-light);
  color: var(--accent); border-radius: 12px; font-weight: 600;
}
.table-wrapper {
  overflow-x: auto; border: 1px solid var(--border);
  border-radius: var(--radius); background: #fff; box-shadow: var(--shadow);
}
table { width: 100%; border-collapse: collapse; font-size: 15px; }
thead th {
  position: sticky; top: 0; z-index: 10;
  background: var(--bg-secondary); color: var(--text);
  font-weight: 700; font-size: 14px;
  padding: 14px 16px; text-align: left;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
}
tbody tr { transition: background 0.1s; }
tbody tr:hover { background: var(--bg-hover); }
tbody tr:not(:last-child) td { border-bottom: 1px solid var(--border-light); }
td { padding: 14px 16px; vertical-align: top; max-width: 500px; line-height: 1.7; }
td.cell-kr { color: var(--orange); font-weight: 600; font-size: 16px; }
td.cell-jp { color: var(--green); font-weight: 600; font-size: 16px; }
td.cell-desc { color: var(--text-secondary); }
td.cell-num { color: var(--purple); text-align: center; white-space: nowrap; font-weight: 600; }
td.cell-img { text-align: center; padding: 8px; }
td.cell-img img {
  max-width: 120px; max-height: 150px; border-radius: 8px;
  border: 1px solid var(--border); object-fit: contain;
  cursor: pointer; transition: transform 0.2s;
}
td.cell-img img:hover { transform: scale(1.05); box-shadow: var(--shadow-lg); }

/* CATEGORY ROW */
tr.cat-row td {
  background: var(--accent-light); color: var(--accent);
  font-weight: 700; font-size: 15px; padding: 10px 16px;
  border-bottom: 2px solid rgba(9,105,218,0.2) !important;
}

/* CELL */
.cell-content {
  white-space: pre-wrap; word-break: break-word; cursor: pointer;
  padding: 4px 6px; border-radius: 6px; transition: background 0.1s;
}
.cell-content:hover { background: var(--bg-hover); }
.cell-edit {
  width: 100%; min-height: 60px; background: #fff;
  color: var(--text); border: 2px solid var(--accent);
  font-family: inherit; font-size: 15px; line-height: 1.6;
  resize: vertical; outline: none; padding: 8px 10px; border-radius: 6px;
}
mark { background: var(--highlight); color: var(--orange); padding: 1px 3px; border-radius: 3px; font-weight: 600; }

/* TOAST */
.copy-toast {
  position: fixed; bottom: 28px; right: 28px;
  background: var(--green); color: #fff;
  padding: 12px 24px; border-radius: var(--radius);
  font-size: 14px; font-weight: 600;
  opacity: 0; transform: translateY(10px); transition: all 0.3s;
  pointer-events: none; z-index: 1000; box-shadow: var(--shadow-lg);
}
.copy-toast.visible { opacity: 1; transform: translateY(0); }

/* CARD VIEW */
.char-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 18px;
}
.char-card {
  background: #fff; border: 1px solid var(--border);
  border-radius: var(--radius); padding: 22px; transition: all 0.2s;
  box-shadow: var(--shadow);
}
.char-card:hover { border-color: var(--accent); box-shadow: var(--shadow-lg); }
.char-card-header {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid var(--border-light);
  gap: 14px;
}
.char-card-header-left { display: flex; gap: 16px; align-items: flex-start; flex: 1; }
.char-img {
  width: 80px; height: 100px; border-radius: 8px;
  border: 1px solid var(--border); object-fit: cover; flex-shrink: 0;
  cursor: pointer;
}
.char-img:hover { box-shadow: var(--shadow-lg); }
.char-name-kr { font-size: 20px; font-weight: 800; color: var(--orange); }
.char-name-jp { font-size: 16px; color: var(--green); font-weight: 600; margin-top: 2px; }
.char-meta { display: flex; gap: 6px; flex-wrap: wrap; flex-shrink: 0; }
.char-badge { font-size: 12px; padding: 3px 10px; border-radius: 12px; font-weight: 600; }
.char-badge-gender { background: var(--purple-bg); color: var(--purple); }
.char-badge-ep { background: var(--accent-light); color: var(--accent); }
.char-field { margin-bottom: 10px; }
.char-field-label {
  font-size: 12px; color: var(--text-muted); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;
}
.char-field-value {
  font-size: 15px; color: var(--text-secondary); white-space: pre-wrap;
  word-break: break-word; cursor: pointer; padding: 4px 6px;
  border-radius: 6px; transition: background 0.1s; line-height: 1.7;
}
.char-field-value:hover { background: var(--bg-hover); }

/* VIEW TOGGLE */
.view-toggle { display: flex; gap: 4px; margin-left: auto; }
.view-btn {
  padding: 6px 14px; font-size: 13px; font-weight: 600;
  border: 2px solid var(--border); background: #fff;
  color: var(--text-secondary); border-radius: var(--radius);
  cursor: pointer; transition: all 0.15s;
}
.view-btn.active { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

/* IMAGE MODAL */
.img-modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: none; align-items: center; justify-content: center;
  z-index: 9999; cursor: pointer;
}
.img-modal.visible { display: flex; }
.img-modal img {
  max-width: 90vw; max-height: 90vh; border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

/* EMPTY */
.empty-state { text-align: center; padding: 80px 20px; color: var(--text-muted); }
.empty-state-icon { font-size: 56px; margin-bottom: 16px; }
.empty-state-title { font-size: 20px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* RESPONSIVE */
@media (max-width: 768px) {
  .header { padding: 10px 14px; }
  .header-top { flex-wrap: wrap; }
  .search-container { max-width: 100%; order: 3; width: 100%; }
  .shortcut-hint { display: none; }
  .content { padding: 14px; }
  .char-grid { grid-template-columns: 1fr; }
  td { padding: 10px 12px; font-size: 14px; }
}

/* BACK TO TOP */
.back-top {
  position: fixed; bottom: 28px; left: 28px;
  width: 44px; height: 44px; border-radius: 50%;
  background: #fff; border: 2px solid var(--border);
  color: var(--text-secondary); font-size: 20px;
  cursor: pointer; display: none; align-items: center; justify-content: center;
  transition: all 0.2s; z-index: 100; box-shadow: var(--shadow);
}
.back-top:hover { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
.back-top.visible { display: flex; }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div>
      <div class="logo">PICK ME UP 設定集</div>
      <div class="logo-sub">~低レア★英雄の成り上がり~</div>
    </div>
    <div class="search-container">
      <span class="search-icon">&#128269;</span>
      <input type="text" class="search-input" id="searchInput"
        placeholder="검색어 입력 (KR/JP/설명 모두, 스페이스=AND)" autocomplete="off">
      <button class="search-clear" id="searchClear" onclick="clearSearch()">&times;</button>
      <span class="search-count" id="searchCount"></span>
    </div>
    <div class="shortcut-hint">
      <span><kbd>&#8984;K</kbd> 검색</span>
      <span>클릭=복사</span>
      <span>더블클릭=편집</span>
    </div>
  </div>
  <div class="tabs-container" id="tabs"></div>
</div>

<div class="content" id="content"></div>
<div class="copy-toast" id="copyToast"></div>
<button class="back-top" id="backTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>
<div class="img-modal" id="imgModal" onclick="this.classList.remove('visible')"><img id="imgModalImg"></div>

<script src="data.js"></script>
<script src="img_mapping.js"></script>
<script>
const SHEET_CONFIG = {
  '1. charapter': {
    label: '캐릭터', icon: '&#128100;',
    headers: ['등장화', 'KR', 'JP', '이미지', '성별', '나이', '1인칭', '호칭', '말투', '설정/특징', '호칭(타인)'],
    colMap: [1, 2, 3, -1, 5, 6, 7, 8, 9, 10, 11],
    imgCol: 3, // index in colMap where image goes
    dataStart: 1, cardView: true,
    cellClasses: {0:'cell-num', 1:'cell-kr', 2:'cell-jp', 3:'cell-img'},
  },
  '2. word': {
    label: '용어사전', icon: '&#128214;',
    headers: ['소설화', '웹툰화', 'KR', 'JP(웹툰)', 'JP(소설)', '설명'],
    colMap: [0, 1, 2, 3, 4, 5],
    dataStart: 2,
    cellClasses: {0:'cell-num', 1:'cell-num', 2:'cell-kr', 3:'cell-jp', 4:'cell-jp', 5:'cell-desc'},
  },
  'ゲーム内表記（漫画用）': {
    label: '게임내 표기', icon: '&#127918;',
    headers: ['카테고리', '종류', 'KR', 'JP', '비고'],
    colMap: [0, 1, 2, 3, 4],
    dataStart: 3,
    cellClasses: {0:'cell-num', 2:'cell-kr', 3:'cell-jp', 4:'cell-desc'},
  },
  '【参考用】ノベル先行分概要およびST該当話': {
    label: '노벨/ST', icon: '&#128218;',
    headers: ['ST화', '키워드', '주요인물', '소설화', '소설타이틀'],
    colMap: [1, 2, 3, 4, 5],
    dataStart: 1,
    cellClasses: {0:'cell-num', 3:'cell-num'},
  },
  'アイテム 掲示板ウインドウ（漫画用）': {
    label: '아이템/게시판', icon: '&#128451;',
    headers: null, dataStart: 0, hasSheetImages: true,
  },
  '영웅 정보英雄情報(참조용으로 봐주세요)': {
    label: '영웅 정보', icon: '&#9876;',
    headers: null, dataStart: 0,
  },
  '시스템창 표기 통일(참조)': {
    label: '시스템창', icon: '&#128421;',
    headers: null, dataStart: 0,
  },
  '게임 ui 정리': {
    label: '게임 UI', icon: '&#128241;',
    headers: ['등장화수', '분류', 'KR', 'JP', '비고'],
    colMap: [0, 1, 2, 3, 4],
    dataStart: 3,
    cellClasses: {0:'cell-num', 2:'cell-kr', 3:'cell-jp', 4:'cell-desc'},
  },
  '줄거리시트': {
    label: '줄거리', icon: '&#128221;',
    headers: ['화차', '줄거리', '등장인물', '등장 스킬', '사망인원'],
    colMap: [0, 1, 2, 3, 4],
    dataStart: 3,
    cellClasses: {0:'cell-num'},
  },
  '확인 요청': {
    label: '확인 요청', icon: '&#9989;',
    headers: null, dataStart: 0,
  },
  '05.confirm': {
    label: '컨펌', icon: '&#128203;',
    headers: ['No.', 'Item', 'KR', 'JP', '확인', 'Date'],
    colMap: [0, 1, 2, 3, 4, 5],
    dataStart: 4,
    cellClasses: {0:'cell-num', 2:'cell-kr', 3:'cell-jp'},
  },
};

// Build per-row image lookup: { "sheetName": { rowIdx: "imageFile.png" } }
const IMG_BY_ROW = {};
for (const [sheet, imgs] of Object.entries(IMG_MAP)) {
  IMG_BY_ROW[sheet] = {};
  for (const img of imgs) {
    // For character sheet, col=4 is the image column
    if (sheet === '1. charapter' && img.col === 4) {
      IMG_BY_ROW[sheet][img.row] = img.file;
    }
    // Store all images by row+col for other sheets
    const key = `${img.row}_${img.col}`;
    if (!IMG_BY_ROW[sheet]._all) IMG_BY_ROW[sheet]._all = {};
    IMG_BY_ROW[sheet]._all[key] = img.file;
  }
}

let currentTab = '__all__';
let currentSearch = '';
let charViewMode = 'card';
let searchTimer = null;

let savedEdits = {};
try { savedEdits = JSON.parse(localStorage.getItem('pmu_edits') || '{}'); } catch(e) {}
function applyEdits() {
  for (const [k, edits] of Object.entries(savedEdits)) {
    const data = RAW_DATA[k];
    if (!data) continue;
    for (const [ri, ci, val] of edits) { if (data[ri]) data[ri][ci] = val; }
  }
}
applyEdits();

function init() {
  buildTabs();
  renderContent();
  const input = document.getElementById('searchInput');
  input.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      currentSearch = input.value.trim();
      document.getElementById('searchClear').classList.toggle('visible', currentSearch.length > 0);
      renderContent(); updateTabCounts();
    }, 150);
  });
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); input.focus(); input.select(); }
    if (e.key === 'Escape') { clearSearch(); input.blur(); document.getElementById('imgModal').classList.remove('visible'); }
  });
  window.addEventListener('scroll', () => {
    document.getElementById('backTop').classList.toggle('visible', window.scrollY > 400);
  });
}

function clearSearch() {
  document.getElementById('searchInput').value = ''; currentSearch = '';
  document.getElementById('searchClear').classList.remove('visible');
  renderContent(); updateTabCounts();
}

function buildTabs() {
  const c = document.getElementById('tabs');
  let h = `<button class="tab active" data-tab="__all__" onclick="switchTab('__all__')">&#128270; 전체</button>`;
  for (const [key, cfg] of Object.entries(SHEET_CONFIG)) {
    if (!RAW_DATA[key]) continue;
    const cnt = getDataRows(key).length;
    h += `<button class="tab" data-tab="${key}" onclick="switchTab('${key}')">${cfg.icon} ${cfg.label} <span class="tab-count">${cnt}</span></button>`;
  }
  c.innerHTML = h;
}

function updateTabCounts() {
  if (!currentSearch) { buildTabs(); switchTab(currentTab); return; }
  const terms = currentSearch.toLowerCase().split(/\s+/);
  document.querySelectorAll('.tab[data-tab]').forEach(tab => {
    const key = tab.dataset.tab;
    if (key === '__all__') return;
    const cnt = getDataRows(key).filter(r => { const t = r.join(' ').toLowerCase(); return terms.every(term => t.includes(term)); }).length;
    const el = tab.querySelector('.tab-count');
    if (el) { el.textContent = cnt; el.style.color = cnt > 0 ? 'var(--orange)' : ''; el.style.fontWeight = cnt > 0 ? '700' : ''; }
  });
}

function getDataRows(key) {
  const data = RAW_DATA[key]; const cfg = SHEET_CONFIG[key];
  if (!data || !cfg) return [];
  return data.slice(cfg.dataStart || 0).filter(r => r.some(c => c.trim()));
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  renderContent();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function renderContent() {
  const container = document.getElementById('content');
  let total = 0;
  if (currentTab === '__all__') {
    let html = '';
    for (const [key, cfg] of Object.entries(SHEET_CONFIG)) {
      const r = renderSheet(key, cfg, true);
      if (r.mc > 0 || !currentSearch) html += r.html;
      total += r.mc;
    }
    container.innerHTML = (currentSearch && total === 0) ? renderEmpty() : html;
  } else {
    const cfg = SHEET_CONFIG[currentTab];
    if (cfg) { const r = renderSheet(currentTab, cfg, false); total = r.mc; container.innerHTML = (currentSearch && total === 0) ? renderEmpty() : r.html; }
  }
  const ce = document.getElementById('searchCount');
  if (currentSearch) { ce.textContent = `${total}건`; ce.classList.add('visible'); } else { ce.classList.remove('visible'); }
}

function renderEmpty() {
  return `<div class="empty-state"><div class="empty-state-icon">&#128269;</div><div class="empty-state-title">검색 결과 없음</div><p>"${esc(currentSearch)}"에 대한 결과를 찾을 수 없습니다</p></div>`;
}

function renderSheet(key, cfg, isGlobal) {
  const data = RAW_DATA[key];
  if (!data || !data.length) return { html: '', mc: 0 };
  if (key === '1. charapter' && charViewMode === 'card') return renderCards(key, cfg, data, isGlobal);
  return renderTable(key, cfg, data, isGlobal);
}

function filterRows(rows) {
  if (!currentSearch) return rows;
  const terms = currentSearch.toLowerCase().split(/\s+/);
  return rows.filter(r => { const t = r.join(' ').toLowerCase(); return terms.every(term => t.includes(term)); });
}

function getCharImg(rowIdx) {
  const m = IMG_BY_ROW['1. charapter'];
  return m ? m[rowIdx] : null;
}

function renderTable(key, cfg, data, isGlobal) {
  const colMap = cfg.colMap;
  let rows = data.slice(cfg.dataStart || 0).filter(r => r.some(c => c.trim()));
  let filtered = filterRows(rows);
  const mc = currentSearch ? filtered.length : rows.length;
  if (currentSearch && mc === 0 && isGlobal) return { html: '', mc: 0 };
  const display = currentSearch ? filtered : rows;

  let html = `<div class="sheet-section"><div class="sheet-title">${cfg.icon} ${cfg.label} <span class="badge">${display.length}건</span>${key === '1. charapter' ? viewToggle() : ''}</div><div class="table-wrapper"><table>`;

  if (cfg.headers && colMap) {
    html += '<thead><tr>' + cfg.headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
  } else {
    const maxC = Math.min(data.reduce((m, r) => Math.max(m, r.filter(c => c.trim()).length), 0), 12);
    html += '<thead><tr>' + Array.from({length: maxC}, (_, i) => `<th>Col ${i+1}</th>`).join('') + '</tr></thead>';
  }

  html += '<tbody>';
  for (const row of display) {
    const rowIdx = data.indexOf(row);
    html += '<tr>';
    if (colMap) {
      for (let i = 0; i < colMap.length; i++) {
        const ci = colMap[i];
        const cls = cfg.cellClasses?.[i] || '';
        if (ci === -1 && key === '1. charapter') {
          // Image column
          const imgFile = getCharImg(rowIdx);
          html += `<td class="cell-img">${imgFile ? `<img src="images/${imgFile}" onclick="showImg(this.src)" loading="lazy" alt="캐릭터">` : '<span style="color:var(--text-muted)">-</span>'}</td>`;
        } else if (ci === -1) {
          html += '<td>-</td>';
        } else {
          const val = ci < row.length ? row[ci] : '';
          html += `<td class="${cls}">${cell(val, key, rowIdx, ci)}</td>`;
        }
      }
    } else {
      // Auto columns - include images if sheet has them
      const maxC = Math.min(row.filter(c => c.trim()).length + 1, 12);
      const sheetImgs = IMG_BY_ROW[key]?._all || {};
      for (let i = 0; i < maxC; i++) {
        const imgKey = `${rowIdx}_${i}`;
        const imgFile = sheetImgs[imgKey];
        if (imgFile) {
          html += `<td class="cell-img"><img src="images/${imgFile}" onclick="showImg(this.src)" loading="lazy">${row[i]?.trim() ? '<br>' + cell(row[i], key, rowIdx, i) : ''}</td>`;
        } else {
          html += `<td>${cell(row[i] || '', key, rowIdx, i)}</td>`;
        }
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table></div></div>';
  return { html, mc };
}

function renderCards(key, cfg, data, isGlobal) {
  let rows = data.slice(cfg.dataStart || 0).filter(r => r.some(c => c.trim()));
  rows = rows.filter(r => (r[2]?.trim()) || (r[3]?.trim()));
  let filtered = filterRows(rows);
  const mc = currentSearch ? filtered.length : rows.length;
  if (currentSearch && mc === 0 && isGlobal) return { html: '', mc: 0 };
  const display = currentSearch ? filtered : rows;

  let html = `<div class="sheet-section"><div class="sheet-title">${cfg.icon} ${cfg.label} <span class="badge">${display.length}건</span>${viewToggle()}</div><div class="char-grid">`;

  for (const row of display) {
    const rowIdx = data.indexOf(row);
    const [kr, jp, gender, age, ep, pro, called, speech, desc, callOth] =
      [row[2]||'', row[3]||'', row[5]||'', row[6]||'', row[1]||'', row[7]||'', row[8]||'', row[9]||'', row[10]||'', row[11]||''];
    const imgFile = getCharImg(rowIdx);

    html += `<div class="char-card"><div class="char-card-header"><div class="char-card-header-left">`;
    if (imgFile) {
      html += `<img class="char-img" src="images/${imgFile}" onclick="showImg(this.src)" loading="lazy" alt="${esc(kr)}">`;
    }
    html += `<div><div class="char-name-kr">${hl(esc(kr))}</div><div class="char-name-jp">${hl(esc(jp))}</div></div></div>`;
    html += `<div class="char-meta">${gender ? `<span class="char-badge char-badge-gender">${esc(gender)}</span>` : ''}${ep ? `<span class="char-badge char-badge-ep">EP.${esc(String(ep))}</span>` : ''}</div></div>`;

    for (const [lbl, val] of [['나이', age], ['1인칭', pro], ['호칭', called], ['말투/어미', speech], ['설정 및 특징', desc], ['호칭(타인에게)', callOth]]) {
      if (val?.trim()) {
        html += `<div class="char-field"><div class="char-field-label">${lbl}</div><div class="char-field-value" onclick="copyText(this)">${hl(esc(val))}</div></div>`;
      }
    }
    html += '</div>';
  }
  html += '</div></div>';
  return { html, mc };
}

function viewToggle() {
  return `<div class="view-toggle"><button class="view-btn ${charViewMode==='card'?'active':''}" onclick="toggleView('card')">&#127183; 카드</button><button class="view-btn ${charViewMode==='table'?'active':''}" onclick="toggleView('table')">&#128200; 테이블</button></div>`;
}
function toggleView(m) { charViewMode = m; renderContent(); }

function cell(value, sk, ri, ci) {
  if (!value?.trim()) return '<span style="color:var(--text-muted)">-</span>';
  const id = `${sk}|${ri}|${ci}`;
  return `<div class="cell-content" onclick="copyText(this)" ondblclick="editCell(this,'${btoa(encodeURIComponent(id))}')" title="클릭=복사">${hl(esc(value))}</div>`;
}

function showImg(src) {
  const modal = document.getElementById('imgModal');
  document.getElementById('imgModalImg').src = src;
  modal.classList.add('visible');
}

function editCell(el, idB64) {
  const id = decodeURIComponent(atob(idB64));
  const [sheet, ri, ci] = id.split('|');
  const row = RAW_DATA[sheet]?.[parseInt(ri)];
  if (!row) return;
  const ta = document.createElement('textarea');
  ta.className = 'cell-edit'; ta.value = row[parseInt(ci)] || '';
  el.replaceWith(ta); ta.focus();
  ta.style.height = Math.max(60, ta.scrollHeight) + 'px';
  const save = () => {
    row[parseInt(ci)] = ta.value;
    if (!savedEdits[sheet]) savedEdits[sheet] = [];
    savedEdits[sheet] = savedEdits[sheet].filter(e => !(e[0]===parseInt(ri) && e[1]===parseInt(ci)));
    savedEdits[sheet].push([parseInt(ri), parseInt(ci), ta.value]);
    localStorage.setItem('pmu_edits', JSON.stringify(savedEdits));
    renderContent(); showToast('저장됨');
  };
  ta.addEventListener('blur', save);
  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { ta.removeEventListener('blur', save); renderContent(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') save();
  });
}

function copyText(el) {
  const text = el.textContent || el.innerText;
  navigator.clipboard.writeText(text).then(() => {
    showToast('복사됨: ' + (text.length > 40 ? text.slice(0,40)+'...' : text));
  }).catch(() => {
    const ta = document.createElement('textarea'); ta.value = text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('복사됨');
  });
}

function showToast(msg) {
  const t = document.getElementById('copyToast');
  t.textContent = msg; t.classList.add('visible');
  clearTimeout(t._timer); t._timer = setTimeout(() => t.classList.remove('visible'), 1500);
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,'<br>'); }
function hl(text) {
  if (!currentSearch) return text;
  let r = text;
  for (const t of currentSearch.split(/\s+/).filter(Boolean))
    r = r.replace(new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>');
  return r;
}

init();
</script>
</body>
</html>
